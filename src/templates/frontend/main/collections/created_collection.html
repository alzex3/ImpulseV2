{% extends 'frontend/main/collections/main_collection.html' %}


{% block body %}
	<div class="created-collection-display-list align-items-center">
	{% for collection in collections %}
		<div id="collectionDisplay" data-id="{{ collection.id }}" class="created-collection-display">
			<div class="collection-title-display">
				<p class="collection-title inner-font">{{ collection.name }}</p>
				<button class="active-collection-spase" data-col-id="{{ collection.id }}"
				        onclick="ActivateCollection(this)">
					<span>Активировать&nbsp;коллекцию</span>
				</button>
				<div class="dropdown toggle-collection">
					<button class="btn btn-secondary toggle-collection" type="button" data-bs-toggle="dropdown"
					        aria-expanded="false">
						<img src="/static/images/collection/create_cards/img_1.png"></button>
					<ul class="dropdown-menu">
						<li><a class="dropdown-item btn btn-primary open-modal" data-cover="{{ collection.cover }}"
						       data-col-id="{{ collection.id }}" data-motto="{{ collection.motto }}"
						       data-name="{{ collection.name }}" id="openModalBtn" href="#" data-bs-toggle="modal"
						       data-bs-target="#changeCollectionData">Редактировать коллекцию</a></li>
						<li>
							<hr class="dropdown-divider">
						</li>
						<li><a class="dropdown-item " href="#">Удалить коллекцию</a></li>
					</ul>
				</div>
			</div>
			<div class="collection-info">
				<p class="amoun-cards inner-font">Всего карточек: {% if collection.size == "sixtyCards" %}60{% elif collection.size == "eightyCards" %}80{% else %}40{% endif %}</p>
				<p class="collection-status-display inner-font">Статус: {% if collection.status == 'created' %}Созданная{% elif collection.satuse == "active" %}Активная{% else %}В архиве{% endif %}</p>
			</div>
			<div class="collection-items-display">
				<div class="collection-cover-display">
					{% if collection.cover %}
						<img src="{{ collection.cover }}"
						     alt="Collection cover">
					{% else %}
						Обложка коллекции отуствует
					{% endif %}
				</div>
				<div class="collection-description-display">
					{% if collection.motto %}
						<p class="inner-font">{{ collection.motto }}</p>
					{% else %}
						Описание коллекции отсутствует
					{% endif %}
				</div>
			</div>
			<div class="create-cards-display">
				<div class="cards-display">
					<img src="/static/images/cards/common.png" alt="Common cards" class="image-card">
					<div class="card-type-info">
						<h1 class="card-type-name inner-font">Обычные карточки</h1>
						<p class="amount-cards-by-type inner-font">Колличество: {{ collection.amoundCards.common }}</p>
					</div>
					<button id="cardsBatton" onclick="TestFunc(this)" data-id='{{ collection.id }}'
					        data-type="common" data-amount="{{ collection.amoundCards.common }}"
					        class="btn btn-primary" type="button" data-bs-toggle="collapse"
					        data-bs-target="#collapseExample-{{ collection.id }}" aria-expanded="false"
					        aria-controls="collapseExample-{{ collection.id }}">
					</button>
				</div>
				<div class="cards-display">
					<img src="/static/images/cards/uncommon.png" alt="Uncommon cards" class="image-card">
					<div class="card-type-info">
						<h1 class="card-type-name inner-font">Необычные карточки</h1>
						<p class="amount-cards-by-type inner-font">
							Колличество: {{ collection.amoundCards.uncommon }}</p>
					</div>
					<button id="cardsBatton" onclick="TestFunc(this)" data-id='{{ collection.id }}'
					        data-type="uncommon" data-amount="{{ collection.amoundCards.uncommon }}"
					        class="btn btn-primary" type="button" data-bs-toggle="collapse"
					        data-bs-target="#collapseExample-{{ collection.id }}" aria-expanded="false"
					        aria-controls="collapseExample-{{ collection.id }}">
					</button>
				</div>
				<div class="cards-display">
					<img src="/static/images/cards/rare.png" alt="Common cards" class="image-card">
					<div class="card-type-info">
						<h1 class="card-type-name inner-font">Редкие<br>карточки</h1>
						<p class="amount-cards-by-type inner-font">Колличество: {{ collection.amoundCards.rare }}</p>
					</div>
					<button id="cardsBatton" onclick="TestFunc(this)" data-id='{{ collection.id }}'
					        data-type="rare" data-amount="{{ collection.amoundCards.rare }}"
					        class="btn btn-primary" type="button" data-bs-toggle="collapse"
					        data-bs-target="#collapseExample-{{ collection.id }}" aria-expanded="false"
					        aria-controls="collapseExample-{{ collection.id }}">
					</button>
				</div>
				<div class="cards-display">
					<img src="/static/images/cards/legendary.png" alt="Uncommon cards" class="image-card">
					<div class="card-type-info">
						<h1 class="card-type-name inner-font">Легендарные карточки</h1>
						<p class="amount-cards-by-type inner-font">
							Колличество: {{ collection.amoundCards.legendary }}</p>
					</div>
					<button id="cardsBatton" onclick="TestFunc(this)" data-id='{{ collection.id }}'
					        data-type="legendary" data-amount="{{ collection.amoundCards.legendary }}"
					        class="btn btn-primary" type="button" data-bs-toggle="collapse"
					        data-bs-target="#collapseExample-{{ collection.id }}" aria-expanded="false"
					        aria-controls="collapseExample-{{ collection.id }}">
					</button>
				</div>
			</div>
			<div class="dp-col-cards collapse" id="collapseExample-{{ collection.id }}">
				<div id='cardsListDisplay' class="collection-cards-display card card-body">
				</div>
			</div>
		</div>
	{% endfor %}
	<script>
        function TestFunc(button) {
            let id = $(button).data('id');
            let type = $(button).data('type');
            let targetDiv = $(`div[data-id="${id}"]`);
            let amound = $(button).data('amount');
            let cardsListDiv = targetDiv.find('#cardsListDisplay')
            $(`#collapseExample-${id}`).off('shown.bs.collapse').on('shown.bs.collapse', function () {
                console.log('Видимое поле')
                let divSize = '637px'
                let divCollorCss = ''
                if (type === 'common') {
                    divCollorCss = '#867661'
                    divSize = "3200px"
                } else if (type === 'uncommon') {
                    divCollorCss = 'green'
                    divSize = '2000px'
                } else if (type === 'rare') {
                    divCollorCss = 'blue'
                    divSize = '1500px'
                } else {
                    divCollorCss = 'yellow'
                    divSize = '1000px'
                }
                if (targetDiv.height() < 600) {
                    targetDiv.animate({height: divSize}, 500);
                }
                $.ajax({
                    url: `http://127.0.0.1:8000/collection/${id}/cards/?q=${type}`,
                    type: 'GET',
                    success: function (response) {
                        let data = response
                        for (let i = 1; i < amound + 1; i++) {
                            if (i in data) {
                                let CardsCreatedDiv = $('<div class="create-card-form"></div>')
                                CardsCreatedDiv.css('background-color', divCollorCss)
                                let SomeDiv = $('<div class="create-image-form"></div>');
                                let Ptag = $('<p class="inner-font"></p>').text(data[i]['name'])
                                let url = data[i]['url']
                                let newImg = $('<img>', {
                                    src: url,
                                    alt: 'test',
                                });
                                SomeDiv.append(newImg);
                                CardsCreatedDiv.append(SomeDiv)
                                CardsCreatedDiv.append(Ptag)
                                cardsListDiv.append(CardsCreatedDiv)
                            } else {
                                let somediv = $('<div class="create-card-form"></div>')
                                somediv.css('background-color', divCollorCss)
                                let SomeoneDiv = $('<div class="create-image-form"></div>')
                                let CreateLink = $('<a href="#" class="create-cards-link-form inner-font dynamic-element" data-bs-toggle="modal" data-bs-target="#createCardModal" id="createCardLink">Добавить<br>картинку</a>');
                                CreateLink.attr('data-pos', i)
                                CreateLink.attr('data-type', type)
                                CreateLink.on('click', function () {
                                    let collectionId = id
                                    let dataType = $(this).attr('data-type');
                                    let dataPos = $(this).attr('data-pos');
                                    $('#submitBtn').attr('data-type', dataType).attr('data-pos', dataPos).attr('data-col-id', collectionId)
                                });
                                let Ptag = $('<p class="inner-font">Название карточки</p>')
                                SomeoneDiv.append(CreateLink)
                                somediv.append(SomeoneDiv)
                                somediv.append(Ptag)
                                cardsListDiv.append(somediv);
                            }
                        }
                    },
                    error: function (jqXHR, testStatus, errorThrow) {
                        console.log(testStatus, errorThrow)
                    }
                })
            }).off('hidden.bs.collapse').on('hidden.bs.collapse', function () {
                targetDiv.animate({height: '637px'}, 500);
                let someDiv = $(this).find('#cardsListDisplay')
                someDiv.empty()
            })
        }
	</script>
	<div class="modal fade" id="changeCollectionData" tabindex="-1" aria-labelledby="changeCollectionData"
	     aria-hidden="true">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="changeCollectionData">Modal title</h1>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body create-cards-modal-display">
					<div class="main-modal-content" id="mainContentModalCards">
						<form id="updateCollection" enctype="multipart/form-data">
							<div class="change-view-modal-display ">
								<label class="form-control change-photo-button"
								       style="text-align: center; justify-content: right; flex-direction: row-reverse"
								       tabindex="0">Изменить<br>фото
									<img class="change-photo-image" src="/static/images/collection/create_cards/img.png"
									     alt="Change Image">
									<input type="file" name="file" class="invisible" id="inputImageCard"
									       onchange="preview2()">
								</label>
								<div class="collections-views">
									<div class="change-view-collection">
										<img id="frame-view" src="" class="collection-view-display" width="580px"
										     height="279px">
									</div>
								</div>
								<div class="change-photo-button">
									<img class="change-photo-image" src="/static/images/collection/create_cards/img.png"
									     alt="Change Image">
									<p class="inner-font">Изменить<br>фото</p>
								</div>
							</div>
							<div class="input-name-card correct-div-collection">
								<p class="inner-font label-name-input" for="cardsNameInput">Название:</p>
								<p class="inner-font collection-update-name" id="collectionName"></p>
							</div>
							<div class="mb-3 description-cards-input-display">
								<label for="cardInfoInput"
								       class="form-label inner-font description-cards">Описание: </label>
								<textarea class="form-control inner-font" name="motto" id="collectionMotto"
								          placeholder="Введите текст" rows="6"></textarea>
							</div>
							<button type="submit" id="selectChanges" onclick="postChangeCollectionInfo(this)"
							        class="btn btn-primary">Сохранить изменения
							</button>
						</form>
					</div>
				</div>
				<div class="modal-footer">
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="createCardModal" tabindex="-1" aria-labelledby="createCardModalLabel"
	     aria-hidden="true">
	<div class="modal-dialog modal-xl">
	<div class="modal-content">
		<div class="modal-header">
			<h1 class="modal-title fs-5" id="createCardModalLabel">Заголовок модального окна</h1>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
		</div>
		<div class="modal-body create-cards-modal-display">
			<div class="main-modal-content" id="mainContentModalCards">
				<form id="createCads" enctype="multipart/form-data">
					<div class="create-image-modal-display">
						<label class="form-control change-photo-button"
						       style="text-align: center; justify-content: right; flex-direction: row-reverse"
						       tabindex="0">Изменить<br>фото
							<img class="change-photo-image" src="/static/images/collection/create_cards/img.png"
							     alt="Change Image">
							<input type="file" name="file" class="invisible" id="inputImageCard"
							       onchange="preview()" required>
						</label>
						<div class="create-card-form" style="background-color: #867661">
							<div class="create-image-form">
								<img id="frame" src="" class="img-fluid cards-image-view" width="170px"
								     height="216px">
							</div>
							<p class="inner-font">Название карточки</p>
						</div>
						<div class="change-photo-button">
							<img class="change-photo-image" src="/static/images/collection/create_cards/img.png"
							     alt="Change Image">
							<p class="inner-font">Изменить<br>фото</p>
						</div>
					</div>
					<div class="input-name-card">
						<label class="inner-font label-name-input" for="cardsNameInput">Название:</label>
						<input class="inner-font" id="cardsNameInput" name="name" placeholder="Введите название"
						       type="text" required>
					</div>
					<div class="mb-3 description-cards-input-display">
						<label for="cardInfoInput"
						       class="form-label inner-font description-cards">Описание: </label>
						<textarea class="form-control inner-font" name="info" id="cardInfoInput"
						          placeholder="Введите текст" rows="6" required></textarea>
					</div>
					<button type="submit" id="submitBtn" onclick="STestFunc(this)" class="btn btn-primary">Сохранить
					                                                                                       изменения
					</button>
				</form>
			</div>
		</div>
		<div class="modal-footer">
		</div>
		<script>
            function STestFunc(button) {
                event.preventDefault();
                button.style.display = "none";
                const form = new FormData(document.querySelector("form[id='createCads']"));
                const id = button.getAttribute('data-col-id')
                const type = button.getAttribute('data-type')
                const position = button.getAttribute('data-pos')
                form.append('type_', type)
                form.append('position', position)
                fetch(`http://127.0.0.1:8000/collection/${id}/card/create/`, {
                    method: 'POST',
                    credentials: 'include',
                    body: form
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data)
                        const taskId = data.task_id
                        if (taskId) {
                            function checkTaskStatus(taskId) {
                                fetch(`http://127.0.0.1:8000/tasks/${taskId}/`)
                                    .then(response => response.json())
                                    .then(data => {
                                        console.log('Task status:', data.status);
                                        if (data.status === 'SUCCESS' || data.status === 'FAILURE') {
                                            clearInterval(checkInterval);
                                            console.log(data);
                                            location.href = ''
                                        }
                                    })
                                    .catch(error => console.error('Error:', error));
                            }

                            const checkInterval = setInterval(() => checkTaskStatus(taskId), 500);
                        }


                    })
                    .catch(error => console.error(error));
            };
		</script>
	</div>
	<script>
        function preview() {
            let frame = document.getElementById('frame');
            frame.style.display = 'block'
            frame.src = URL.createObjectURL(event.target.files[0]);
        }

        function preview2() {
            let frame = document.getElementById('frame-view');
            frame.style.display = 'block'
            frame.src = URL.createObjectURL(event.target.files[0]);
        }
	</script>
	<script>
        function ActivateCollection(button) {
            let id = $(button).data('col-id');
            const dictx = {"status": "active"}
            const zer = JSON.stringify(dictx)
            console.log(zer)
            console.log(id)
            fetch(`http://127.0.0.1:8000/collection/${id}/change/status/`, {
                method: 'PATCH',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json;charset=utf-8'
                },
                body: zer
            })
                .then(response => response.json())
                .then(data => {
                    if (data.detail === 'Collection is not full') {
                        alert('Коллекция не полная')
                    } else if (data.detail === 'There is already an active collection') {
                        alert('Уже есть кативная коллекция')
                    } else {
                        location.href = 'http://127.0.0.1:8000/pages/collections/active/';
                    }
                })
                .catch(error => {
                        console.error('Error:', error)
                    }
                );
        }
	</script>
	<script>
        $(document).ready(function () {
            $('.open-modal').on('click', function (e) {
                e.preventDefault(); // Предотвращаем стандартное поведение ссылки
                var modalId = $(this).data('bs-target'); // Получаем идентификатор модального окна из атрибута data-bs-target
                var dataId = $(this).data('col-id');
                console.log('DAta')
                $('#collectionName').text($(this).data('name'))
                $('#collectionMotto').val($(this).data('motto'))
                $('#selectChanges').attr('data-id', dataId)
                var cover = $(this).data('cover')
                if (cover) {
                    $('#frame-view').attr('src', cover)
                }


            });
        });
	</script>
	<script>
        function postChangeCollectionInfo(button) {
            event.preventDefault();
            var id = $(button).data('id')
            const form = new FormData(document.querySelector("form[id='updateCollection']"));
            const object = {};
            form.forEach(function (value, key) {
                object[key] = value;
            });

            fetch(`http://127.0.0.1:8000/collection/${id}/change/`, {
                method: 'PUT',
                credentials: 'include',
                body: form
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    if (data.task_id) {
                        console.log(data.task_id)
                        console.log(data['task_id'])
                        const taskId = data['task_id']

                        function checkTaskStatus(taskId) {
                            fetch(`http://127.0.0.1:8000/tasks/${taskId}/`)
                                .then(response => response.json())
                                .then(data => {
                                    console.log('Task status:', data.status);
                                    if (data.status === 'SUCCESS' || data.status === 'FAILURE') {
                                        clearInterval(checkInterval);
                                        console.log(data);
                                        location.href = 'http://127.0.0.1:8000/pages/collections/created/?status=created';
                                    }
                                })
                                .catch(error => console.error('Error:', error));
                        }

                        const checkInterval = setInterval(() => checkTaskStatus(taskId), 200);
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки данных:', error)
                });
        }
	</script>

{% endblock %}
